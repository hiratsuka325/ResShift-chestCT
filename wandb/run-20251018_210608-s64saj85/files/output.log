/usr/local/lib/python3.8/dist-packages/albumentations/__init__.py:13: UserWarning: A new version of Albumentations is available: 2.0.8 (you have 1.4.18). Upgrade using: pip install -U albumentations. To disable automatic update checks, set the environment variable NO_ALBUMENTATIONS_UPDATE to 1.
  check_for_updates()
trainer:
  target: trainer.TrainerDifIR
model:
  target: models.unet.UNetModelSwin
  ckpt_path: null
  params:
    image_size: 64
    in_channels: 3
    model_channels: 160
    out_channels: 3
    attention_resolutions:
    - 64
    - 32
    - 16
    - 8
    dropout: 0
    channel_mult:
    - 1
    - 2
    - 2
    - 4
    num_res_blocks:
    - 2
    - 2
    - 2
    - 2
    conv_resample: true
    dims: 2
    use_fp16: false
    num_head_channels: 32
    use_scale_shift_norm: true
    resblock_updown: false
    swin_depth: 2
    swin_embed_dim: 192
    window_size: 8
    mlp_ratio: 4
    cond_lq: true
    lq_size: 64
diffusion:
  target: models.script_util.create_gaussian_diffusion
  params:
    sf: 4
    schedule_name: exponential
    schedule_kwargs:
      power: 0.3
    etas_end: 0.99
    steps: 15
    min_noise_level: 0.04
    kappa: 2.0
    weighted_mse: false
    predict_type: xstart
    timestep_respacing: null
    scale_factor: 1.0
    normalize_input: true
    latent_flag: true
autoencoder:
  target: ldm.models.autoencoder.VQModelTorch
  ckpt_path: weights/autoencoder_vq_f4.pth
  use_fp16: true
  tune_decoder: false
  params:
    lora_tune_decoder: false
    embed_dim: 3
    n_embed: 8192
    ddconfig:
      double_z: false
      z_channels: 3
      resolution: 256
      in_channels: 3
      out_ch: 3
      ch: 128
      ch_mult:
      - 1
      - 2
      - 4
      num_res_blocks: 2
      attn_resolutions: []
      dropout: 0.0
      padding_mode: zeros
degradation:
  sf: 4
  resize_prob:
  - 0.2
  - 0.7
  - 0.1
  resize_range:
  - 0.15
  - 1.5
  gaussian_noise_prob: 0.5
  noise_range:
  - 1
  - 30
  poisson_scale_range:
  - 0.05
  - 3.0
  gray_noise_prob: 0.4
  jpeg_range:
  - 30
  - 95
  second_order_prob: 0.5
  second_blur_prob: 0.8
  resize_prob2:
  - 0.3
  - 0.4
  - 0.3
  resize_range2:
  - 0.3
  - 1.2
  gaussian_noise_prob2: 0.5
  noise_range2:
  - 1
  - 25
  poisson_scale_range2:
  - 0.05
  - 2.5
  gray_noise_prob2: 0.4
  jpeg_range2:
  - 30
  - 95
  gt_size: 256
  resize_back: false
  use_sharp: false
data:
  train:
    type: PairedImageDataset
    params:
      opt:
        dataroot_gt: ../ChestCT/HR
        dataroot_lq: ../ChestCT/LR
        dataroot_mask: ../ChestCT/mask
        meta_info_file: data/meta_info/meta_info_ChestCT_train_1345681011121416_part.txt
        io_backend:
          type: disk
        gt_size: 256
        use_hflip: true
        use_rot: true
        scale: 4
        phase: train
  val:
    type: PairedImageDataset
    params:
      opt:
        dataroot_gt: ../ChestCT/HR
        dataroot_lq: ../ChestCT/LR
        dataroot_mask: ../ChestCT/mask
        meta_info_file: data/meta_info/meta_info_ChestCT_val_2715_part_60.txt
        io_backend:
          type: disk
        scale: 4
        phase: val
train:
  lr: 5.0e-05
  lr_min: 2.0e-05
  lr_schedule: null
  warmup_iterations: 5000
  batch:
  - 8
  - 1
  microbatch: 8
  num_workers: 4
  prefetch_factor: 2
  weight_decay: 0
  ema_rate: 0.999
  iterations: 300000
  save_freq: 10000
  log_freq:
  - 200
  - 2000
  - 1
  local_logging: true
  tf_logging: false
  use_ema_val: true
  val_freq: ${train.save_freq}
  val_y_channel: true
  val_resolution: ${model.params.lq_size}
  val_padding_mode: reflect
  use_amp: true
  seed: 123456
  global_seeding: false
  compile:
    flag: false
    mode: reduce-overhead
  scale: 4
division:
  division_size: 64
  overlap_size: 4
logger:
  wandb:
    project: experiment5
    name: ronbunnomama
    id: null
save_dir: results
resume: ''
cfg_path: configs/realsr_swinunet_realesrgan256.yaml
/usr/local/lib/python3.8/dist-packages/timm/models/layers/__init__.py:48: FutureWarning: Importing from timm.models.layers is deprecated, please import via timm.layers
  warnings.warn(f"Importing from {__name__} is deprecated, please import via timm.layers", FutureWarning)
/usr/local/lib/python3.8/dist-packages/torch/functional.py:504: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at ../aten/src/ATen/native/TensorShape.cpp:3526.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]

Number of parameters: 118.59M
Restoring autoencoder from weights/autoencoder_vq_f4.pth
building MemoryEfficientAttnBlock with 512 in_channels...
Working with z of shape (1, 3, 64, 64) = 12288 dimensions.
building MemoryEfficientAttnBlock with 512 in_channels...
Loading autoencoder from weights/autoencoder_vq_f4.pth...
Loaded Done
Loading LIIPS Metric: vgg...
Setting up [LPIPS] perceptual loss: trunk [vgg], v[0.1], spatial [off]
/usr/local/lib/python3.8/dist-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.
  warnings.warn(
/usr/local/lib/python3.8/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=VGG16_Weights.IMAGENET1K_V1`. You can also use `weights=VGG16_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)
Loading model from: /usr/local/lib/python3.8/dist-packages/lpips/weights/v0.1/vgg.pth
Loading dataset: 100%|████████████████████████| 9387/9387 [1:10:06<00:00,  2.23file/s]
Loading dataset: 100%|██████████████████████████████| 60/60 [00:27<00:00,  2.20file/s]
Number of images in train data set: 9387
Number of images in val data set: 60
Train: 000200/300000, Loss/MSE: t(1):6.1e-01/6.1e-01, t(8):6.9e-01/6.9e-01, t(15):7.3e-01/7.3e-01, lr:1.99e-06
Train: 000400/300000, Loss/MSE: t(1):1.9e-01/1.9e-01, t(8):4.0e-01/4.0e-01, t(15):6.3e-01/6.3e-01, lr:3.99e-06
Train: 000600/300000, Loss/MSE: t(1):6.3e-02/6.3e-02, t(8):3.4e-01/3.4e-01, t(15):5.6e-01/5.6e-01, lr:5.99e-06
Train: 000800/300000, Loss/MSE: t(1):4.0e-02/4.0e-02, t(8):3.0e-01/3.0e-01, t(15):4.6e-01/4.6e-01, lr:7.99e-06
Train: 001000/300000, Loss/MSE: t(1):2.7e-02/2.7e-02, t(8):2.7e-01/2.7e-01, t(15):3.8e-01/3.8e-01, lr:9.99e-06
Train: 001200/300000, Loss/MSE: t(1):2.1e-02/2.1e-02, t(8):2.5e-01/2.5e-01, t(15):3.5e-01/3.5e-01, lr:1.20e-05
Train: 001400/300000, Loss/MSE: t(1):1.5e-02/1.5e-02, t(8):2.4e-01/2.4e-01, t(15):3.3e-01/3.3e-01, lr:1.40e-05
Train: 001600/300000, Loss/MSE: t(1):1.3e-02/1.3e-02, t(8):2.3e-01/2.3e-01, t(15):3.3e-01/3.3e-01, lr:1.60e-05
Train: 001800/300000, Loss/MSE: t(1):1.2e-02/1.2e-02, t(8):2.3e-01/2.3e-01, t(15):3.3e-01/3.3e-01, lr:1.80e-05
Train: 002000/300000, Loss/MSE: t(1):1.0e-02/1.0e-02, t(8):2.3e-01/2.3e-01, t(15):3.2e-01/3.2e-01, lr:2.00e-05
Train: 002200/300000, Loss/MSE: t(1):1.1e-02/1.1e-02, t(8):2.3e-01/2.3e-01, t(15):3.2e-01/3.2e-01, lr:2.20e-05
Train: 002400/300000, Loss/MSE: t(1):9.4e-03/9.4e-03, t(8):2.2e-01/2.2e-01, t(15):3.2e-01/3.2e-01, lr:2.40e-05
Train: 002600/300000, Loss/MSE: t(1):8.8e-03/8.8e-03, t(8):2.3e-01/2.3e-01, t(15):3.2e-01/3.2e-01, lr:2.60e-05
Train: 002800/300000, Loss/MSE: t(1):8.1e-03/8.1e-03, t(8):2.3e-01/2.3e-01, t(15):3.1e-01/3.1e-01, lr:2.80e-05
Train: 003000/300000, Loss/MSE: t(1):7.9e-03/7.9e-03, t(8):2.2e-01/2.2e-01, t(15):3.2e-01/3.2e-01, lr:3.00e-05
Train: 003200/300000, Loss/MSE: t(1):8.2e-03/8.2e-03, t(8):2.3e-01/2.3e-01, t(15):3.2e-01/3.2e-01, lr:3.20e-05
Train: 003400/300000, Loss/MSE: t(1):7.4e-03/7.4e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:3.40e-05
Train: 003600/300000, Loss/MSE: t(1):6.6e-03/6.6e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:3.60e-05
Train: 003800/300000, Loss/MSE: t(1):7.3e-03/7.3e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:3.80e-05
Train: 004000/300000, Loss/MSE: t(1):6.8e-03/6.8e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:4.00e-05
Train: 004200/300000, Loss/MSE: t(1):6.3e-03/6.3e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:4.20e-05
Train: 004400/300000, Loss/MSE: t(1):6.8e-03/6.8e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:4.40e-05
Train: 004600/300000, Loss/MSE: t(1):5.9e-03/5.9e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:4.60e-05
Train: 004800/300000, Loss/MSE: t(1):5.4e-03/5.4e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:4.80e-05
Train: 005000/300000, Loss/MSE: t(1):5.6e-03/5.6e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 005200/300000, Loss/MSE: t(1):5.5e-03/5.5e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:5.00e-05
Train: 005400/300000, Loss/MSE: t(1):5.2e-03/5.2e-03, t(8):2.2e-01/2.2e-01, t(15):3.1e-01/3.1e-01, lr:5.00e-05
Train: 005600/300000, Loss/MSE: t(1):4.9e-03/4.9e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 005800/300000, Loss/MSE: t(1):4.6e-03/4.6e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 006000/300000, Loss/MSE: t(1):4.9e-03/4.9e-03, t(8):2.2e-01/2.2e-01, t(15):2.9e-01/2.9e-01, lr:5.00e-05
Train: 006200/300000, Loss/MSE: t(1):4.2e-03/4.2e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 006400/300000, Loss/MSE: t(1):4.3e-03/4.3e-03, t(8):2.1e-01/2.1e-01, t(15):3.1e-01/3.1e-01, lr:5.00e-05
Train: 006600/300000, Loss/MSE: t(1):4.2e-03/4.2e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 006800/300000, Loss/MSE: t(1):4.1e-03/4.1e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 007000/300000, Loss/MSE: t(1):4.2e-03/4.2e-03, t(8):2.1e-01/2.1e-01, t(15):2.9e-01/2.9e-01, lr:5.00e-05
Train: 007200/300000, Loss/MSE: t(1):3.9e-03/3.9e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 007400/300000, Loss/MSE: t(1):4.0e-03/4.0e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 007600/300000, Loss/MSE: t(1):3.8e-03/3.8e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 007800/300000, Loss/MSE: t(1):3.9e-03/3.9e-03, t(8):2.2e-01/2.2e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 008000/300000, Loss/MSE: t(1):3.9e-03/3.9e-03, t(8):2.1e-01/2.1e-01, t(15):3.1e-01/3.1e-01, lr:5.00e-05
Train: 008200/300000, Loss/MSE: t(1):4.1e-03/4.1e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 008400/300000, Loss/MSE: t(1):3.7e-03/3.7e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 008600/300000, Loss/MSE: t(1):3.5e-03/3.5e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 008800/300000, Loss/MSE: t(1):3.9e-03/3.9e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 009000/300000, Loss/MSE: t(1):3.5e-03/3.5e-03, t(8):2.1e-01/2.1e-01, t(15):3.1e-01/3.1e-01, lr:5.00e-05
Train: 009200/300000, Loss/MSE: t(1):3.4e-03/3.4e-03, t(8):2.1e-01/2.1e-01, t(15):2.9e-01/2.9e-01, lr:5.00e-05
Train: 009400/300000, Loss/MSE: t(1):3.5e-03/3.5e-03, t(8):2.2e-01/2.2e-01, t(15):2.9e-01/2.9e-01, lr:5.00e-05
Train: 009600/300000, Loss/MSE: t(1):3.5e-03/3.5e-03, t(8):2.1e-01/2.1e-01, t(15):3.0e-01/3.0e-01, lr:5.00e-05
Train: 009800/300000, Loss/MSE: t(1):3.4e-03/3.4e-03, t(8):2.1e-01/2.1e-01, t(15):2.9e-01/2.9e-01, lr:5.00e-05
Train: 010000/300000, Loss/MSE: t(1):3.3e-03/3.3e-03, t(8):2.1e-01/2.1e-01, t(15):3.1e-01/3.1e-01, lr:5.00e-05
Elapsed time: 2578.26s
====================================================================================================
Traceback (most recent call last):
  File "main.py", line 71, in <module>
    trainer.train()
  File "/workspace/lung/hiratsuka/ResShift/trainer.py", line 322, in train
    self.validation()
  File "/workspace/lung/hiratsuka/ResShift/trainer.py", line 1061, in validation
    psnr, count = util_image.calculate_psnr_mask(
  File "/workspace/lung/hiratsuka/ResShift/utils/util_image.py", line 180, in calculate_psnr_mask
    img = to_y_channel(img)
  File "/workspace/lung/hiratsuka/ResShift/basicsr/metrics/metric_util.py", line 43, in to_y_channel
    img = bgr2ycbcr(img, y_only=True)
  File "/workspace/lung/hiratsuka/ResShift/basicsr/utils/matlab_functions.py", line 235, in bgr2ycbcr
    img = _convert_input_type_range(img)
NameError: name '_convert_input_type_range' is not defined
Traceback (most recent call last):
  File "main.py", line 71, in <module>
    trainer.train()
  File "/workspace/lung/hiratsuka/ResShift/trainer.py", line 322, in train
    self.validation()
  File "/workspace/lung/hiratsuka/ResShift/trainer.py", line 1061, in validation
    psnr, count = util_image.calculate_psnr_mask(
  File "/workspace/lung/hiratsuka/ResShift/utils/util_image.py", line 180, in calculate_psnr_mask
    img = to_y_channel(img)
  File "/workspace/lung/hiratsuka/ResShift/basicsr/metrics/metric_util.py", line 43, in to_y_channel
    img = bgr2ycbcr(img, y_only=True)
  File "/workspace/lung/hiratsuka/ResShift/basicsr/utils/matlab_functions.py", line 235, in bgr2ycbcr
    img = _convert_input_type_range(img)
NameError: name '_convert_input_type_range' is not defined
